# 添加新的 AI 图像模型

## 兼容 OpenAI 请求格式的模型

指的是可以使用 openai SDK 进行请求，并且请求参数和和返回值和 dall-e 以及 gpt-image-x 系列一致。

以智谱的 CogView-4 为例，它是一个兼容 openai 请求格式的模型，可以按照以下步骤添加：

1. 在对应的 ai models 文件 `src/config/aiModels/zhipu.ts` 中，添加模型配置，例如：

```ts
const zhipuImageModels: AIImageModelCard[] = [
  // 添加模型配置
  // https://bigmodel.cn/dev/howuse/image-generation-model/cogview-4
  {
    description:
      'CogView-4 是智谱首个支持生成汉字的开源文生图模型，在语义理解、图像生成质量、中英文字生成能力等方面全面提升，支持任意长度的中英双语输入，能够生成在给定范围内的任意分辨率图像。',
    displayName: 'CogView-4',
    enabled: true,
    id: 'cogview-4',
    parameters: {
      prompt: {
        default: '',
      },
      size: {
        default: '1024x1024',
        enum: ['1024x1024', '768x1344', '864x1152', '1344x768', '1152x864', '1440x720', '720x1440'],
      },
    },
    releasedAt: '2025-03-04',
    type: 'image',
  },
];
```

2. 执行下 `npx i18n` 命令，更新模型描述的翻译文件

## 不兼容 OpenAI 请求格式的模型

对于不兼容 OpenAI 格式的图像生成模型，需要实现自定义的 `createImage` 方法。有两种主要实现方式：

### 方式一：使用 OpenAI Compatible Factory（推荐）

如果你的 Provider 使用 `openaiCompatibleFactory`，可以通过传入自定义的 `createImage` 函数（参考 [PR #8534](https://github.com/lobehub/lobe-chat/pull/8534)）：

1. **创建独立的图像生成函数**：

```ts
// src/libs/model-runtime/provider-name/createImage.ts
export const createProviderImage = async (
  payload: ImageGenerationPayload,
  options: any,
): Promise<ImageGenerationResponse> => {
  const { model, prompt, ...params } = payload;

  // 调用 Provider 的原生 API
  const result = await callProviderAPI({
    model,
    prompt,
    // 转换参数格式
    custom_param: params.width,
    // ...
  });

  // 返回统一格式
  return {
    created: Date.now(),
    data: [{ url: result.imageUrl }],
  };
};
```

2. **在 Provider 初始化时传入**：

```ts
// src/libs/model-runtime/provider-name/index.ts
export const LobeProviderAI = openaiCompatibleFactory({
  constructorOptions: {
    // ... 其他配置
  },
  createImage: createProviderImage, // 传入自定义实现
  provider: ModelProvider.ProviderName,
});
```

### 方式二：在 Provider 类中直接实现

如果你的 Provider 有独立的类实现，可以直接在类中添加 `createImage` 方法（参考 [PR #8503](https://github.com/lobehub/lobe-chat/pull/8503)）：

```ts
// src/libs/model-runtime/provider-name/index.ts
export class LobeProviderAI {
  async createImage(
    payload: ImageGenerationPayload,
    options?: ChatStreamCallbacks,
  ): Promise<ImageGenerationResponse> {
    const { model, prompt, ...params } = payload;

    // 调用原生 API 并处理响应
    const result = await this.client.generateImage({
      model,
      prompt,
      // 参数转换
    });

    return {
      created: Date.now(),
      data: [{ url: result.url }],
    };
  }
}
```

## 重要说明

1. **支持的参数**：图像生成目前只支持 `src/libs/standard-parameters/index.ts` 中定义的标准参数：
   - `prompt` (必需)：生成图像的提示词
   - `aspectRatio`：宽高比（如 "16:9", "1:1"）
   - `width` / `height`：图像宽高
   - `size`：预设尺寸（如 "1024x1024"）
   - `seed`：随机种子
   - `steps`：生成步数
   - `cfg`：引导缩放
   - 其他参数请查看源文件

2. **测试要求**：为自定义实现添加完整的单元测试，确保覆盖成功场景和各种错误情况

3. **错误处理**：统一使用 `AgentRuntimeError` 进行错误封装，保持错误信息的一致性
